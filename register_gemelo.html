<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Registrar Gemelo</title>
<style>
  body{font-family:Arial, sans-serif;margin:18px;background:#f7fbff}
  .wrap{max-width:560px;margin:auto;background:#fff;padding:16px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  select,input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-top:8px}
  button{margin-top:10px;padding:10px;border-radius:8px;background:#0b5cff;color:#fff;border:0;cursor:pointer}
  .muted{font-size:13px;color:#666;margin-top:6px}
</style>
</head>
<body>
<div class="wrap">
  <h3>Registrar Gemelo</h3>
  <div id="info" class="muted">Cargando turno...</div>

  <label>Ruta original</label>
  <select id="routeSel"></select>

  <label>Ruta gemelo (escribe la ruta que se creó)</label>
  <input id="twin" placeholder="Ej: A2" />

  <label>Comentario (opcional)</label>
  <textarea id="notes" rows="3" placeholder="Razón, espacio, observación..."></textarea>

  <button onclick="submitGemelo()">Enviar</button>
  <div id="result" class="muted"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCdiJAKX8RYT9DNanmp25e4FbmZJupHJJ8",
  authDomain: "paquetes-stc1.firebaseapp.com",
  projectId: "paquetes-stc1",
  storageBucket: "paquetes-stc1.firebasestorage.app",
  messagingSenderId: "561895525942",
  appId: "1:561895525942:web:883c13c63fb1447c4fd297",
  measurementId: "G-1TEMJD6VGX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
firebase.auth().signInAnonymously().catch(console.error);

const params = new URLSearchParams(location.search);
const shift = params.get('shift');
const info = id => document.getElementById('info').innerText = id;
const setResult = t => document.getElementById('result').innerText = t;

if(!shift){
  info('No se especificó shift en la URL. Pide al admin generar QR.');
} else {
  info('Cargando turno: ' + shift);
  db.collection('shifts').doc(shift).get().then(snap=>{
    if(!snap.exists){ info('Turno no encontrado: ' + shift); return; }
    const data = snap.data();
    info('Turno: ' + (data.name||shift));
    const sel = document.getElementById('routeSel');
    sel.innerHTML = data.routes.map(r=>`<option>${r}</option>`).join('');
  }).catch(e=>info('Error cargando turno: ' + e.message));
}

async function submitGemelo(){
  const route = document.getElementById('routeSel').value || '';
  const twin  = document.getElementById('twin').value.trim();
  const notes = document.getElementById('notes').value.trim();
  if(!route || !twin){ setResult('Completa ruta y gemelo.'); return; }
  setResult('Enviando...');
  try{
    await db.collection('shifts').doc(shift).collection('gemelos').add({
      route, twin, notes, createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userUid: firebase.auth().currentUser ? firebase.auth().currentUser.uid : null
    });
    setResult('Registrado ✅');
    document.getElementById('twin').value=''; document.getElementById('notes').value='';
  }catch(e){
    console.error(e);
    setResult('Error: ' + e.message);
  }
}
</script>
</body>
</html>
