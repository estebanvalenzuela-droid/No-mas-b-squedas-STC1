<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin | Analizador de Paquetes</title>
<style>
  body{font-family:Arial, sans-serif;margin:20px;background:#f4f4f9}
  .container{max-width:980px;margin:auto;background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.1)}
  textarea{width:100%;height:220px;margin:12px 0;padding:10px;border:1px solid #ccc;border-radius:6px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  button{padding:10px 14px;background:#007BFF;color:#fff;border:0;border-radius:6px;cursor:pointer}
  button:hover{background:#0056b3}
  .package{background:#e9ecef;border:1px solid #ced4da;padding:10px;margin:8px 0;border-radius:6px}
  .summary{background:#f8f9fa;border:1px dashed #ced4da;padding:10px;border-radius:6px;margin:12px 0}
  small.muted{color:#666}
</style>
</head>
<body>
<div class="container">
  <h1>Admin ‚Äì Analizador</h1>

  <label>ID p√∫blico (fijo) para publicar:
    <input id="pubId" value="station-results" style="padding:6px"/>
  </label>
  <br><small class="muted">Ejemplo: <code>mel-scl-01</code></small>

  <textarea id="sheetData" placeholder="Pega tus filas aqu√≠‚Ä¶"></textarea>
  <div class="row">
    <button onclick="processData()">Procesar</button>
    <button onclick="publish()">Publicar</button>
    <button onclick="copyViewerURL()">Copiar URL del viewer</button>
  </div>
  <div id="summary" class="summary">Sin procesar.</div>
  <div id="list"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<script>
/*** üîß Configuraci√≥n Firebase real ***/
const firebaseConfig = {
  apiKey: "AIzaSyCdiJAKX8RYT9DNanmp25e4FbmZJupHJJ8",
  authDomain: "paquetes-stc1.firebaseapp.com",
  projectId: "paquetes-stc1",
  storageBucket: "paquetes-stc1.appspot.com",
  messagingSenderId: "561895525942",
  appId: "1:561895525942:web:883c13c63fb1447c4fd297",
  measurementId: "G-1TEMJD6VGX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* Login an√≥nimo: necesario para escribir en Firestore */
firebase.auth().signInAnonymously().catch(console.error);

/*** üîé Bloque de estado de autenticaci√≥n / dominios ***/
const statusDiv = document.createElement('div');
statusDiv.id = 'status';
statusDiv.style.cssText =
  'margin:10px 0;padding:8px;border:1px dashed #ccc;border-radius:6px;color:#333;background:#f8f9fa';
statusDiv.textContent = 'Comprobando autenticaci√≥n‚Ä¶';
document.querySelector('.container').insertBefore(statusDiv, document.querySelector('#sheetData').parentElement);

firebase.auth().onAuthStateChanged(u => {
  if (u) statusDiv.textContent = `Autenticado (an√≥nimo). UID: ${u.uid}`;
  else   statusDiv.textContent = 'No autenticado.';
});

// Reintento + alert si falla (p.ej. dominio no autorizado)
firebase.auth().signInAnonymously()
  .then(() => console.log('Anon sign-in OK'))
  .catch(e => {
    console.error('Anon sign-in error:', e);
    alert('‚ùå Error de autenticaci√≥n an√≥nima: ' + (e?.message || e));
  });

console.log('Firebase initialized with:', firebase.app().options);

/*** Analizador ***/
const EXPECTED_COLS = 10;
window.__results = [];
const normalize = s => (s??'').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ---------- Parser robusto ---------- */
function splitHard(line){
  // Preferente: Tab, ; , ,  o dos+ espacios
  if (line.includes('\t')) return line.split('\t').map(s=>s.trim());
  if (line.includes(';'))  return line.split(';').map(s=>s.trim());
  if (line.includes(','))  return line.split(',').map(s=>s.trim());
  return line.trim().split(/\s{2,}/).map(s=>s.trim());
}

function heuristicParse(line){
  // Fallback cuando splitHard no logra >=9 columnas
  const t = line.trim().split(/\s+/);
  if (t.length < 7) return []; // imposible
  let i = 0;
  const id = t[i++] ?? '';
  const ruta = t[i++] ?? '';
  const parada = t[i++] ?? '';
  const punto  = t[i++] ?? '';

  // Fecha inbound: dd/mm/yyyy [hh:mm]
  let inbound = '';
  const dateRegex = /^\d{1,2}\/\d{1,2}\/\d{4}$/;
  const timeRegex = /^\d{1,2}:\d{2}$/;
  if (t[i] && dateRegex.test(t[i])) {
    inbound = t[i++];
    if (t[i] && timeRegex.test(t[i])) inbound += ' ' + t[i++];
  }

  const alto  = t[i++] ?? '';
  const ancho = t[i++] ?? '';
  const largo = t[i++] ?? '';

  let rest = t.slice(i).join(' ').trim(); // ubicaci√≥n + posible detalle
  const restNorm = normalize(rest);

  let ubic = '', detalle = '';
  if (restNorm.includes('en la estacion')) {
    // tomar exactamente "En la estaci√≥n" como ubicaci√≥n y el resto como detalle
    const idx = restNorm.indexOf('en la estacion');
    // Calcular posiciones reales respetando may√∫sculas/acentos del original
    const before = rest.slice(0, idx).trim();
    const after  = rest.slice(idx).trim();

    // 'after' empieza en "En la estaci√≥n..."
    // separar ubic ("En la estaci√≥n") del resto del after
    const m = after.match(/^(En\s+la\s+estaci[o√≥]n)(.*)$/i);
    if (m) {
      ubic = m[1].trim();
      detalle = (before + ' ' + (m[2]||'')).trim();
    } else {
      // fallback conservador
      ubic = 'En la estaci√≥n';
      detalle = (before + ' ' + after.replace(/En\s+la\s+estaci[o√≥]n/i,'').trim()).trim();
    }
  } else {
    // No encontramos exactamente "En la estaci√≥n"
    ubic = rest; detalle = '';
  }

  // Devuelve arreglo estilo columnas
  return [id, ruta, parada, punto, inbound, alto, ancho, largo, ubic, detalle];
}

function splitSmart10(line){
  // 1) Intento duro
  let cols = splitHard(line);
  if (cols.length >= 9) return cols;
  // 2) Heur√≠stico
  cols = heuristicParse(line);
  return cols;
}
/* ---------- Fin parser ---------- */

function processData(){
  const raw=document.getElementById('sheetData').value.trim();
  const lines=raw.split(/\r?\n/).filter(l=>l.trim());
  const list=document.getElementById('list');
  const sum=document.getElementById('summary');
  list.innerHTML=''; window.__results=[];
  let total=0,found=0,skipped=0;

  lines.forEach(line=>{
    total++;
    let cols = splitSmart10(line);
    if (cols.length > EXPECTED_COLS)
      cols = cols.slice(0,9).concat([cols.slice(9).join(' ')]);
    if (cols.length < 9){ skipped++; return; }

    const id=cols[0]||'N/A';
    const ruta=cols[1]||'N/A';
    const inbound=(cols[4]||'').trim();
    const loc=cols[8]||'';
    const detalle=(cols[9]&&cols[9].length)?cols[9]:'conveyable';

    // ‚úÖ Solo EXACTAMENTE "En la estaci√≥n"
    if (normalize(loc) === 'en la estacion'){
      found++;
      window.__results.push({id, ruta, inbound: inbound||'N/A', detalle});
      const div=document.createElement('div'); div.className='package';
      div.innerHTML=`<p><strong>ID:</strong> ${id}</p>
                     <p><strong>Ruta:</strong> ${ruta}</p>
                     <p><strong>Fecha inbound:</strong> ${inbound||'N/A'}</p>
                     <p><strong>Detalle:</strong> ${detalle}</p>`;
      list.appendChild(div);
    }
  });

  sum.innerHTML = `<strong>Resumen:</strong> Filas: ${total} ¬∑ En la estaci√≥n: ${found} ¬∑ Saltadas: ${skipped}`;
}

function viewerURL(){
  const id=document.getElementById('pubId').value.trim()||'station-results';
  const base=location.origin+location.pathname.replace(/admin\.html$/,'')+'viewer.html';
  return `${base}?id=${encodeURIComponent(id)}`;
}
function copyViewerURL(){
  const url=viewerURL();
  navigator.clipboard?.writeText(url).then(()=>alert('URL copiada:\n'+url)).catch(()=>prompt('Copia la URL:',url));
}

/*** Publicaci√≥n con manejo de errores ***/
async function publish(){
  if(!window.__results || window.__results.length === 0){
    alert('Procesa datos primero.');
    return;
  }
  const user = firebase.auth().currentUser;
  if (!user) {
    alert('‚ùå No est√°s autenticado (an√≥nimo). Habilita Anonymous y autoriza el dominio en Firebase.');
    console.warn('currentUser es null');
    return;
  }

  const id = (document.getElementById('pubId').value || 'station-results').trim();
  const payload = {
    items: window.__results,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  try {
    console.log('Publicando en Firestore ‚Üí results/', id, payload);
    await db.collection('results').doc(id).set(payload);
    const url = location.origin + location.pathname.replace(/admin\.html$/,'') + 'viewer.html?id=' + encodeURIComponent(id);
    alert('Publicado ‚úÖ\nViewer: ' + url);
  } catch (e) {
    console.error('Error al publicar:', e);
    alert('‚ùå Error al publicar: ' + (e?.message || e));
  }
}
</script>
</body>
</html>
